<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast8 Rider Pro - Earn & Track</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #ffb703; --dark: #0f172a; --green: #10b981; --red: #ef4444; }
        body { font-family: 'Poppins', sans-serif; background: #f1f5f9; margin: 0; padding-bottom: 50px; }
        
        /* Dashboard Header */
        header { background: var(--dark); color: white; padding: 25px; border-radius: 0 0 30px 30px; text-align: center; }
        .wallet-card { background: white; margin: -30px 20px 20px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; justify-content: space-around; text-align: center; }
        .wallet-box b { font-size: 20px; color: var(--dark); }
        .wallet-box small { color: gray; display: block; }

        /* Task Management */
        .container { padding: 15px; }
        .task-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 6px solid var(--gold); position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .service-tag { position: absolute; top: 15px; right: 15px; background: #fef3c7; color: #92400e; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 12px; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-start { background: var(--gold); color: #000; }
        .btn-done { background: var(--green); color: #fff; }
        .btn-map { background: #e2e8f0; color: #475569; }

        /* Tabs */
        .tabs { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .tab-btn { padding: 8px 20px; border-radius: 20px; border: none; background: #e2e8f0; cursor: pointer; font-weight: 600; }
        .tab-btn.active { background: var(--dark); color: white; }
    </style>
</head>
<body>

<header>
    <h2 style="margin:0;">Fast8 Rider Panel</h2>
    <div id="rider-info" style="margin-top:5px; opacity:0.8;">Welcome back!</div>
</header>

<div class="wallet-card">
    <div class="wallet-box"><small>Today's Earn</small><b id="w-earn">‚Çπ0</b></div>
    <div class="wallet-box"><small>Orders Done</small><b id="w-orders">0</b></div>
</div>

<div class="container">
    <div id="login-form">
        <input type="text" id="rName" placeholder="Enter Your Rider Name" style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">
        <button class="btn btn-start" onclick="initRider()">Access My Dashboard</button>
    </div>

    <div id="rider-dash" style="display:none;">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTasks('active')">Active Tasks</button>
            <button class="tab-btn" onclick="showTasks('history')">History</button>
        </div>
        <h3 id="task-title" style="margin-top:25px;">üì¶ Current Deliveries</h3>
        <div id="task-list">Loading your tasks...</div>
    </div>
</div>

<script>
    // Firebase Config remains same
    const firebaseConfig = {
        apiKey: "AIzaSyBpRhuVaHqznb9q8YEJP3Pg19MWv5camXE",
        authDomain: "fast8delivery-a90b4.firebaseapp.com",
        projectId: "fast8delivery-a90b4",
        appId: "1:200027434311:web:9bc6caf3db527b602c3062"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let riderName = "";
    let currentWatch = null;

    function initRider() {
        riderName = document.getElementById('rName').value;
        if(!riderName) return alert("Please enter name");
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('rider-dash').style.display = 'block';
        document.getElementById('rider-info').innerText = "Rider: " + riderName;
        loadStats();
        showTasks('active');
    }

    function loadStats() {
        db.collection("orders").where("assignedTo", "==", riderName).where("status", "==", "Delivered")
        .onSnapshot(snap => {
            let earn = 0;
            snap.forEach(doc => earn += (doc.data().riderEarning || 15));
            document.getElementById('w-earn').innerText = "‚Çπ" + earn;
            document.getElementById('w-orders').innerText = snap.size;
        });
    }

    function showTasks(type) {
        const query = (type === 'active') 
            ? db.collection("orders").where("assignedTo", "==", riderName).where("status", "!=", "Delivered")
            : db.collection("orders").where("assignedTo", "==", riderName).where("status", "==", "Delivered");

        query.onSnapshot(snap => {
            const list = document.getElementById('task-list');
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<p style='text-align:center; color:gray;'>No tasks found.</p>";
            
            snap.forEach(doc => {
                const d = doc.data();
                const address = d.customerAddress || "Address not provided";
                list.innerHTML += `
                    <div class="task-card">
                        <span class="service-tag">${d.serviceType || 'Delivery'}</span>
                        <b>üë§ ${d.customerName}</b><br>
                        <small>üìû ${d.customerPhone}</small>
                        <p style="font-size:13px; margin:10px 0;">üìç ${address}</p>
                        ${type === 'active' ? `
                            <button class="btn btn-map" onclick="window.open('https://www.google.com/maps/search/${address}')">
                                <i class="fas fa-location-arrow"></i> Open Navigation
                            </button>
                            <button class="btn btn-start" onclick="startTracking('${doc.id}')">
                                <i class="fas fa-motorcycle"></i> Start GPS Tracking
                            </button>
                            <button class="btn btn-done" onclick="markDone('${doc.id}')">
                                <i class="fas fa-check-circle"></i> Mark Delivered
                            </button>
                        ` : `<p style="color:var(--green); font-weight:bold;">‚úÖ Delivered - Earning: ‚Çπ${d.riderEarning || 15}</p>`}
                    </div>`;
            });
        });
    }

    function startTracking(id) {
        if (!navigator.geolocation) return alert("GPS not supported");
        alert("GPS Live! Don't close this tab during delivery.");
        currentWatch = navigator.geolocation.watchPosition(pos => {
            db.collection("orders").doc(id).update({
                riderLat: pos.coords.latitude,
                riderLng: pos.coords.longitude,
                status: "Out for Delivery"
            });
        }, null, { enableHighAccuracy: true });
    }

    function markDone(id) {
        if(confirm("Confirm delivery and payment collection?")) {
            if(currentWatch) navigator.geolocation.clearWatch(currentWatch);
            db.collection("orders").doc(id).update({ status: "Delivered" });
        }
    }
</script>
</body>
</html>
