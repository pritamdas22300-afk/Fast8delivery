<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fast8 Bondhu - Order Fresh</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --red: #e63946; --yellow: #ffb703; --dark: #1d3557; --light: #f8f9fa; --white: #ffffff; }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--light); color: var(--dark); padding-bottom: 70px; }

        /* --- Header & Layout --- */
        header { background: var(--red); color: white; padding: 20px; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .loading-screen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        
        /* --- Grid & Cards --- */
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .u-card { background: white; border-radius: 15px; padding: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; border: 1px solid #eee; }
        .stock-badge { position: absolute; top: 8px; right: 8px; font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #eee; }
        .out-of-stock { opacity: 0.6; filter: grayscale(1); pointer-events: none; }
        
        /* --- Cart Sheet --- */
        .cart-overlay { position: fixed; bottom: 0; width: 100%; background: white; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); z-index: 2000; transform: translateY(100%); transition: 0.3s ease; }
        .cart-overlay.active { transform: translateY(0); }
        
        .btn { padding: 12px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-yellow { background: var(--yellow); color: var(--dark); }
        .btn-yellow:active { transform: scale(0.98); }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { text-align: center; color: #888; text-decoration: none; font-size: 11px; }
        .nav-item.active { color: var(--red); }
        
        .hidden { display: none !important; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; }
    </style>
</head>
<body>

<div id="loader" class="loading-screen"><i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--red)"></i></div>

<header>
    <div><h2 style="font-size: 18px;">Fast8 Bondhu</h2><small id="user-status">Detecting location...</small></div>
    <div onclick="toggleCart()" style="position: relative; cursor: pointer;">
        <i class="fas fa-shopping-basket fa-lg"></i>
        <span id="cart-count" style="position:absolute; top:-10px; right:-10px; background:var(--yellow); color:var(--dark); padding:2px 6px; border-radius:50%; font-size:10px; font-weight:700;">0</span>
    </div>
</header>

<div id="page-home">
    <div class="product-grid" id="product-list"></div>
</div>

<div id="page-orders" class="hidden" style="padding: 20px;">
    <h3>My Recent Orders</h3>
    <div id="active-orders-container" style="margin-top: 15px;"></div>
</div>

<div id="cart-modal" class="cart-overlay">
    <div style="width: 40px; height: 5px; background: #ddd; border-radius: 10px; margin: 0 auto 15px;"></div>
    <h3>Review Items</h3>
    <div id="cart-items" style="max-height: 150px; overflow-y: auto; margin: 15px 0;"></div>
    
    <div id="checkout-form">
        <input type="text" id="cust-name" placeholder="Receiver's Name">
        <input type="text" id="cust-phone" placeholder="Phone Number">
        <input type="text" id="cust-address" placeholder="Delivery Address (House/Street)">
    </div>

    <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 18px; margin: 15px 0;">
        <span>Total:</span><span id="cart-total-display">₹0</span>
    </div>
    
    <button class="btn btn-yellow" id="place-order-btn" onclick="placeOrder()">CONFIRM & PAY COD</button>
    <button onclick="toggleCart()" style="width: 100%; background: none; border: none; margin-top: 12px; color: #888;">Back to Menu</button>
</div>

<div class="bottom-nav">
    <a href="javascript:void(0)" class="nav-item active" id="nav-home" onclick="showPage('home')"><i class="fas fa-home fa-lg"></i><br>Shop</a>
    <a href="javascript:void(0)" class="nav-item" id="nav-orders" onclick="showPage('orders')"><i class="fas fa-receipt fa-lg"></i><br>Orders</a>
    <a href="tel:9100000000" class="nav-item"><i class="fas fa-phone fa-lg"></i><br>Help</a>
</div>

<script>
    // --- FIREBASE INIT ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let cart = [];
    let products = [];
    let currentUser = null;

    // --- AUTHENTICATION ---
    auth.onAuthStateChanged(user => {
        if (!user) {
            auth.signInAnonymously().catch(err => console.error("Auth Error:", err));
        } else {
            currentUser = user;
            document.getElementById('user-status').innerText = "Ready to Order";
            document.getElementById('loader').style.display = 'none';
            trackUserOrders();
        }
    });

    // --- PRODUCT LOGIC ---
    function loadProducts() {
        db.collection("products").onSnapshot(snap => {
            const list = document.getElementById('product-list');
            list.innerHTML = "";
            products = [];
            snap.forEach(doc => {
                const p = doc.data(); p.id = doc.id;
                products.push(p);
                const isOut = p.stock <= 0;
                list.innerHTML += `
                    <div class="u-card ${isOut ? 'out-of-stock' : ''}">
                        <span class="stock-badge">${isOut ? 'Sold Out' : p.stock + ' left'}</span>
                        <div style="height:60px; background:#f9f9f9; border-radius:10px; margin-bottom:10px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-box-open" style="color:#ddd;"></i>
                        </div>
                        <h4 style="font-size:13px; height:38px; overflow:hidden;">${p.name}</h4>
                        <div style="color:var(--red); font-weight:700; font-size:16px; margin:5px 0;">₹${p.price}</div>
                        <button class="btn btn-yellow" style="padding:6px; font-size:12px;" onclick="addToCart('${p.id}')">
                            ${isOut ? 'Unavailable' : 'Add to Cart'}
                        </button>
                    </div>`;
            });
        });
    }

    // --- CART LOGIC ---
    function addToCart(id) {
        const item = products.find(p => p.id === id);
        const inCart = cart.find(c => c.id === id);
        
        if (inCart) {
            if (inCart.qty + 1 > item.stock) return alert("Not enough stock!");
            inCart.qty++;
        } else {
            cart.push({...item, qty: 1});
        }
        updateCartUI();
    }

    function updateCartUI() {
        const count = cart.reduce((acc, curr) => acc + curr.qty, 0);
        const total = cart.reduce((acc, curr) => acc + (curr.price * curr.qty), 0);
        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-total-display').innerText = "₹" + (total + 20); // 20 is delivery
        
        document.getElementById('cart-items').innerHTML = cart.map(item => `
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; border-bottom:1px solid #eee; padding-bottom:5px;">
                <span>${item.name} x ${item.qty}</span>
                <span style="font-weight:600;">₹${item.price * item.qty}</span>
            </div>`).join("");
    }

    function toggleCart() {
        document.getElementById('cart-modal').classList.toggle('active');
    }

    // --- TRANSACTIONAL ORDERING (Production Safety) ---
    async function placeOrder() {
        const name = document.getElementById('cust-name').value;
        const phone = document.getElementById('cust-phone').value;
        const address = document.getElementById('cust-address').value;

        if(!name || !phone || !address || cart.length === 0) return alert("Please fill all details!");
        
        const btn = document.getElementById('place-order-btn');
        btn.disabled = true;
        btn.innerText = "Processing...";

        // Start Firestore Transaction to prevent stock race conditions
        try {
            await db.runTransaction(async (transaction) => {
                const productRefs = cart.map(item => ({ ref: db.collection("products").doc(item.id), qty: item.qty }));
                
                // 1. Verify all stock first
                for (const p of productRefs) {
                    const sfDoc = await transaction.get(p.ref);
                    if (!sfDoc.exists() || sfDoc.data().stock < p.qty) {
                        throw "One or more items went out of stock!";
                    }
                }

                // 2. Decrement stock
                productRefs.forEach(p => {
                    transaction.update(p.ref, { stock: firebase.firestore.FieldValue.increment(-p.qty) });
                });

                // 3. Create Order
                const orderRef = db.collection("orders").doc();
                transaction.set(orderRef, {
                    userId: currentUser.uid,
                    customerName: name,
                    customerPhone: phone,
                    customerAddress: address,
                    items: cart.map(i => ({id: i.id, name: i.name, qty: i.qty, price: i.price})),
                    totalAmount: cart.reduce((acc, curr) => acc + (curr.price * curr.qty), 0) + 20,
                    status: "Pending",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            });

            alert("Order Success! Delivery partner will be assigned soon.");
            cart = []; updateCartUI(); toggleCart(); showPage('orders');
        } catch (e) {
            alert("Order Failed: " + e);
        } finally {
            btn.disabled = false;
            btn.innerText = "CONFIRM & PAY COD";
        }
    }

    function trackUserOrders() {
        db.collection("orders")
          .where("userId", "==", currentUser.uid)
          .orderBy("timestamp", "desc")
          .onSnapshot(snap => {
            const container = document.getElementById('active-orders-container');
            if (snap.empty) {
                container.innerHTML = `<p style="text-align:center; color:#888; margin-top:40px;">No orders yet.</p>`;
                return;
            }
            container.innerHTML = "";
            snap.forEach(doc => {
                const o = doc.data();
                container.innerHTML += `
                    <div style="background:white; padding:15px; border-radius:15px; margin-bottom:12px; border:1px solid #eee;">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-weight:700;">#${doc.id.substring(0,6)}</span>
                            <span style="color:var(--red); font-weight:700;">₹${o.totalAmount}</span>
                        </div>
                        <div style="font-size:12px; margin-top:5px; color:#666;">Status: <b>${o.status}</b></div>
                    </div>`;
            });
        });
    }

    function showPage(p) {
        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-orders').classList.add('hidden');
        document.getElementById('nav-home').classList.remove('active');
        document.getElementById('nav-orders').classList.remove('active');
        
        document.getElementById('page-' + p).classList.remove('hidden');
        document.getElementById('nav-' + p).classList.add('active');
    }

    window.onload = loadProducts;
</script>
</body>
</html>
